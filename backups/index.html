<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TRA Vehicle Tax (UMVVS)</title>
    <style>
      :root {
        color-scheme: light;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 0;
        padding: 24px;
        background: #f6f7f9;
        color: #1a1a1a;
      }
      .container {
        max-width: 980px;
        margin: 0 auto;
      }
      .card {
        background: #fff;
        border: 1px solid #e6e8ee;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      }
      h1 {
        margin: 0 0 12px;
        font-size: 20px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      label {
        display: block;
        font-size: 12px;
        color: #4a4a4a;
        margin-bottom: 6px;
      }
      select,
      input,
      button,
      textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #cfd6e4;
        background: #fff;
        font-size: 14px;
      }
      button {
        cursor: pointer;
        background: #0b5fff;
        border-color: #0b5fff;
        color: #fff;
        font-weight: 600;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: end;
      }
      .row > div {
        flex: 1;
      }
      .status {
        margin-top: 10px;
        font-size: 12px;
        color: #5a5a5a;
      }
      .error {
        color: #b00020;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      th,
      td {
        border-bottom: 1px solid #eef1f7;
        padding: 10px;
        text-align: left;
        font-size: 14px;
        vertical-align: top;
      }
      th {
        font-size: 12px;
        color: #4a4a4a;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      textarea {
        height: 220px;
        resize: vertical;
      }
      @media (max-width: 720px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .row {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>TRA Vehicle Tax Calculator (UMVVS)</h1>

        <div class="grid">
          <div>
            <label for="make">Make</label>
            <select id="make"></select>
          </div>

          <div>
            <label for="modelFilter">Model/Body filter</label>
            <select id="modelFilter"></select>
          </div>

          <div>
            <label for="modelBody">Model / Body</label>
            <select id="modelBody"></select>
          </div>

          <div>
            <label for="yom">Year of manufacture</label>
            <select id="yom"></select>
          </div>

          <div>
            <label for="country">Country of origin</label>
            <select id="country"></select>
          </div>

          <div>
            <label for="fuel">Fuel type</label>
            <select id="fuel"></select>
          </div>

          <div>
            <label for="engine">Engine capacity</label>
            <select id="engine"></select>
          </div>

          <div class="row">
            <div>
              <button id="calculate">Calculate tax</button>
            </div>
            <div>
              <button id="reset" type="button" style="background:#fff;color:#0b5fff;border-color:#0b5fff;">Reset</button>
            </div>
          </div>
        </div>

        <div id="status" class="status"></div>

        <div id="result" style="display:none; margin-top: 16px;">
          <table>
            <thead>
              <tr>
                <th>Field</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody id="taxTable"></tbody>
          </table>

          <div style="margin-top: 12px;">
            <label for="jsonOut">Raw JSON</label>
            <textarea id="jsonOut" class="mono" readonly></textarea>
          </div>
        </div>
      </div>
    </div>

    <script>
      const makeEl = document.getElementById('make');
      const modelFilterEl = document.getElementById('modelFilter');
      const modelBodyEl = document.getElementById('modelBody');
      const yomEl = document.getElementById('yom');
      const countryEl = document.getElementById('country');
      const fuelEl = document.getElementById('fuel');
      const engineEl = document.getElementById('engine');
      const calculateEl = document.getElementById('calculate');
      const resetEl = document.getElementById('reset');
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      const taxTableEl = document.getElementById('taxTable');
      const jsonOutEl = document.getElementById('jsonOut');

      let modelBodiesCache = [];

      function setStatus(text, isError = false) {
        statusEl.textContent = text;
        statusEl.className = isError ? 'status error' : 'status';
      }

      function setDisabled(disabled) {
        for (const el of [makeEl, modelFilterEl, modelBodyEl, yomEl, countryEl, fuelEl, engineEl, calculateEl, resetEl]) {
          el.disabled = disabled;
        }
      }

      function clearSelect(selectEl) {
        selectEl.innerHTML = '';
      }

      function setPlaceholder(selectEl, placeholder) {
        clearSelect(selectEl);
        const ph = document.createElement('option');
        ph.value = '';
        ph.textContent = placeholder;
        selectEl.appendChild(ph);
        selectEl.value = '';
      }

      function setOptions(selectEl, items, placeholder) {
        setPlaceholder(selectEl, placeholder);
        for (const item of items) {
          const opt = document.createElement('option');
          opt.value = String(item.value);
          opt.textContent = String(item.label);
          selectEl.appendChild(opt);
        }
      }

      async function fetchJson(path, params = {}) {
        const url = new URL(path, window.location.origin);
        for (const [k, v] of Object.entries(params)) {
          if (v === undefined || v === null || v === '') continue;
          url.searchParams.set(k, v);
        }
        const res = await fetch(url.toString(), {
          headers: {
            Accept: 'application/json',
          },
        });
        const text = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
        return JSON.parse(text);
      }

      function getMakeId() {
        const val = makeEl.value;
        return val ? Number(val) : null;
      }

      async function loadMakes() {
        setStatus('Loading makes...');
        const data = await fetchJson('/umvvs/getMakes');
        const items = data.map((m) => ({ value: m.makeId, label: m.makeName }));
        setOptions(makeEl, items, 'Select make');
      }

      function getModelKey(modelBody) {
        const parts = String(modelBody || '').split(' - ').map((x) => x.trim()).filter(Boolean);
        return parts.length ? parts[0] : String(modelBody || '').trim();
      }

      function uniqueSorted(values) {
        const seen = new Set();
        const out = [];
        for (const v of values) {
          const s = String(v || '').trim();
          if (!s) continue;
          if (seen.has(s)) continue;
          seen.add(s);
          out.push(s);
        }
        out.sort((a, b) => a.localeCompare(b));
        return out;
      }

      async function loadModelBodyFilterForMake() {
        const makeId = getMakeId();
        modelBodiesCache = [];
        setPlaceholder(modelFilterEl, 'Select filter');
        setPlaceholder(modelBodyEl, 'Select model/body');
        if (!makeId) return;
        setStatus('Loading model/body options...');
        const data = await fetchJson('/umvvs/getModelBody', { makeId: String(makeId) });
        modelBodiesCache = data.map((x) => x.modelBody).filter(Boolean);
        const keys = uniqueSorted(modelBodiesCache.map(getModelKey));
        const items = [{ value: 'ALL', label: 'ALL' }, ...keys.map((k) => ({ value: k, label: k }))];
        setOptions(modelFilterEl, items, 'Select filter');
      }

      function populateModelBodiesFromFilter() {
        setPlaceholder(modelBodyEl, 'Select model/body');
        const selectedKey = modelFilterEl.value;
        if (!selectedKey) return;
        const filtered =
          selectedKey === 'ALL'
            ? modelBodiesCache
            : modelBodiesCache.filter((x) => getModelKey(x) === selectedKey);
        const items = filtered.map((v) => ({ value: v, label: v }));
        setOptions(modelBodyEl, items, 'Select model/body');
      }

      async function loadYoms() {
        const makeId = getMakeId();
        const modelBody = modelBodyEl.value;
        setPlaceholder(yomEl, 'Select year');
        if (!makeId || !modelBody) return;
        setStatus('Loading year of manufacture...');
        const data = await fetchJson('/umvvs/getYom', { makeId: String(makeId), modelBody });
        const list = data.map((x) => String(x.yom)).filter(Boolean);
        const items = list.map((v) => ({ value: v, label: v }));
        setOptions(yomEl, items, 'Select year');
      }

      async function loadCountries() {
        const makeId = getMakeId();
        const modelBody = modelBodyEl.value;
        const yom = yomEl.value;
        setPlaceholder(countryEl, 'Select country');
        if (!makeId || !modelBody || !yom) return;
        setStatus('Loading countries...');
        const data = await fetchJson('/umvvs/getCountryOfOrigin', {
          makeId: String(makeId),
          modelBody,
          yom,
        });
        const list = data.map((x) => x.countryOfOrigin).filter(Boolean);
        const items = list.map((v) => ({ value: v, label: v }));
        setOptions(countryEl, items, 'Select country');
      }

      async function loadFuelTypes() {
        const makeId = getMakeId();
        const modelBody = modelBodyEl.value;
        const yom = yomEl.value;
        const countryOfOrigin = countryEl.value;
        setPlaceholder(fuelEl, 'Select fuel');
        if (!makeId || !modelBody || !yom || !countryOfOrigin) return;
        setStatus('Loading fuel types...');
        const data = await fetchJson('/umvvs/getFuelType', {
          makeId: String(makeId),
          modelBody,
          yom,
          countryOfOrigin,
        });
        const list = data.map((x) => x.fuelType).filter(Boolean);
        const items = list.map((v) => ({ value: v, label: v }));
        setOptions(fuelEl, items, 'Select fuel');
      }

      async function loadEngineCapacities() {
        const makeId = getMakeId();
        const modelBody = modelBodyEl.value;
        const yom = yomEl.value;
        const countryOfOrigin = countryEl.value;
        const fuelType = fuelEl.value;
        setPlaceholder(engineEl, 'Select engine capacity');
        if (!makeId || !modelBody || !yom || !countryOfOrigin || !fuelType) return;
        setStatus('Loading engine capacities...');
        const data = await fetchJson('/umvvs/getEngineCapacity', {
          makeId: String(makeId),
          modelBody,
          yom,
          countryOfOrigin,
          fuelType,
        });
        const list = data.map((x) => x.engineCapacity).filter(Boolean);
        const items = list.map((v) => ({ value: v, label: v }));
        setOptions(engineEl, items, 'Select engine capacity');
      }

      function toRows(vehicle) {
        const preferredOrder = [
          'make',
          'model',
          'bodyType',
          'yom',
          'country',
          'fuelType',
          'engineCapacity',
          'cifInUSD',
          'importDutyInUSD',
          'exiseDutyInUSD',
          'exiseDutyDueToAgeInUSD',
          'vatInUSD',
          'customProcessingFeeInUSD',
          'railwayDevLevyInUSD',
          'indDevLevy',
          'hivRespLevy',
          'totalImportTaxesInUSD',
          'totalImportTaxesInTZS',
          'vehicleRegistrationFeeInTZS',
          'totalTaxesInTZS',
          'year',
          'quarter',
          'referenceNumber',
        ];

        const entries = Object.entries(vehicle || {});
        const orderIndex = new Map(preferredOrder.map((k, i) => [k, i]));
        entries.sort((a, b) => {
          const ai = orderIndex.has(a[0]) ? orderIndex.get(a[0]) : 9999;
          const bi = orderIndex.has(b[0]) ? orderIndex.get(b[0]) : 9999;
          if (ai !== bi) return ai - bi;
          return a[0].localeCompare(b[0]);
        });
        return entries;
      }

      function renderVehicle(vehicle) {
        taxTableEl.innerHTML = '';
        for (const [k, v] of toRows(vehicle)) {
          const tr = document.createElement('tr');
          const tdK = document.createElement('td');
          tdK.textContent = k;
          tdK.className = 'mono';
          const tdV = document.createElement('td');
          tdV.textContent = v === null || v === undefined ? '' : String(v);
          tr.appendChild(tdK);
          tr.appendChild(tdV);
          taxTableEl.appendChild(tr);
        }
      }

      async function calculate() {
        const makeId = getMakeId();
        const modelBody = modelBodyEl.value;
        const yom = yomEl.value;
        const countryOfOrigin = countryEl.value;
        const fuelType = fuelEl.value;
        const engineCapacity = engineEl.value;

        if (!makeId || !modelBody || !yom || !countryOfOrigin || !fuelType || !engineCapacity) {
          setStatus('Please select all fields before calculating.', true);
          return;
        }

        setStatus('Calculating tax...');
        const data = await fetchJson('/umvvs/getVehicleDetails', {
          makeId: String(makeId),
          modelBody,
          yom,
          cuntryOfOrigin: countryOfOrigin,
          fuelType,
          engineCapacity,
        });
        const vehicle = Array.isArray(data) ? data[0] : data;
        renderVehicle(vehicle);
        jsonOutEl.value = JSON.stringify(vehicle, null, 2);
        resultEl.style.display = 'block';
        setStatus('Done.');
      }

      function clearResult() {
        resultEl.style.display = 'none';
        jsonOutEl.value = '';
      }

      function resetDependents() {
        modelBodiesCache = [];
        setPlaceholder(modelFilterEl, 'Select filter');
        setPlaceholder(modelBodyEl, 'Select model/body');
        setPlaceholder(yomEl, 'Select year');
        setPlaceholder(countryEl, 'Select country');
        setPlaceholder(fuelEl, 'Select fuel');
        setPlaceholder(engineEl, 'Select engine capacity');
      }

      async function init() {
        try {
          setDisabled(true);
          await loadMakes();
          resetDependents();
          setStatus('Ready.');
        } catch (e) {
          setStatus(String(e && e.message ? e.message : e), true);
        } finally {
          setDisabled(false);
        }
      }

      makeEl.addEventListener('change', async () => {
        try {
          setDisabled(true);
          clearResult();
          resetDependents();
          await loadModelBodyFilterForMake();
          setStatus('Ready.');
        } catch (e) {
          setStatus(String(e && e.message ? e.message : e), true);
        } finally {
          setDisabled(false);
        }
      });

      modelFilterEl.addEventListener('change', async () => {
        try {
          setDisabled(true);
          clearResult();
          setPlaceholder(modelBodyEl, 'Select model/body');
          setPlaceholder(yomEl, 'Select year');
          setPlaceholder(countryEl, 'Select country');
          setPlaceholder(fuelEl, 'Select fuel');
          setPlaceholder(engineEl, 'Select engine capacity');
          populateModelBodiesFromFilter();
          setStatus('Ready.');
        } catch (e) {
          setStatus(String(e && e.message ? e.message : e), true);
        } finally {
          setDisabled(false);
        }
      });

      modelBodyEl.addEventListener('change', async () => {
        try {
          setDisabled(true);
          clearResult();
          setPlaceholder(yomEl, 'Select year');
          setPlaceholder(countryEl, 'Select country');
          setPlaceholder(fuelEl, 'Select fuel');
          setPlaceholder(engineEl, 'Select engine capacity');
          await loadYoms();
          setStatus('Ready.');
        } catch (e) {
          setStatus(String(e && e.message ? e.message : e), true);
        } finally {
          setDisabled(false);
        }
      });

      yomEl.addEventListener('change', async () => {
        try {
          setDisabled(true);
          clearResult();
          setPlaceholder(countryEl, 'Select country');
          setPlaceholder(fuelEl, 'Select fuel');
          setPlaceholder(engineEl, 'Select engine capacity');
          await loadCountries();
          setStatus('Ready.');
        } catch (e) {
          setStatus(String(e && e.message ? e.message : e), true);
        } finally {
          setDisabled(false);
        }
      });

      countryEl.addEventListener('change', async () => {
        try {
          setDisabled(true);
          clearResult();
          setPlaceholder(fuelEl, 'Select fuel');
          setPlaceholder(engineEl, 'Select engine capacity');
          await loadFuelTypes();
          setStatus('Ready.');
        } catch (e) {
          setStatus(String(e && e.message ? e.message : e), true);
        } finally {
          setDisabled(false);
        }
      });

      fuelEl.addEventListener('change', async () => {
        try {
          setDisabled(true);
          clearResult();
          setPlaceholder(engineEl, 'Select engine capacity');
          await loadEngineCapacities();
          setStatus('Ready.');
        } catch (e) {
          setStatus(String(e && e.message ? e.message : e), true);
        } finally {
          setDisabled(false);
        }
      });

      engineEl.addEventListener('change', () => {
        clearResult();
      });

      calculateEl.addEventListener('click', async () => {
        try {
          setDisabled(true);
          await calculate();
        } catch (e) {
          setStatus(String(e && e.message ? e.message : e), true);
        } finally {
          setDisabled(false);
        }
      });

      resetEl.addEventListener('click', async () => {
        try {
          setDisabled(true);
          clearResult();
          await init();
        } catch (e) {
          setStatus(String(e && e.message ? e.message : e), true);
        } finally {
          setDisabled(false);
        }
      });

      init();
    </script>
  </body>
</html>
